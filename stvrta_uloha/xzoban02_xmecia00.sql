--SQL script for creating a hospital database and extracting data
--Authors: Radek Zobaník (xzoban02) and Vladimír Mečiar (xmecia00)

DROP TABLE T_Medic CASCADE CONSTRAINTS;
DROP TABLE T_Doctor CASCADE CONSTRAINTS;
DROP TABLE T_Nurse CASCADE CONSTRAINTS;
DROP TABLE T_Patient CASCADE CONSTRAINTS;
DROP TABLE T_Examination CASCADE CONSTRAINTS;
DROP TABLE T_Surgery CASCADE CONSTRAINTS;
DROP TABLE T_Surgery_participants CASCADE CONSTRAINTS;
DROP TABLE T_Location CASCADE CONSTRAINTS;
DROP TABLE T_Prescribed_Drug CASCADE CONSTRAINTS;
DROP TABLE T_Hospitalization CASCADE CONSTRAINTS;
DROP TABLE T_Clinic CASCADE CONSTRAINTS;
DROP TABLE T_Medical_equipment CASCADE CONSTRAINTS;

CREATE TABLE T_Clinic
(
    Clinic_name VARCHAR(30) NOT NULL PRIMARY KEY,
    Telephone   INTEGER
);

--Nurse and medic reffer to medic using their primary key
CREATE TABLE T_Medic
(
    Medic_ID         INTEGER NOT NULL PRIMARY KEY,
    Medic_first_name VARCHAR(20),
    Medic_last_name  VARCHAR(20),
    Clinic_name      VARCHAR(30),
    Duty             VARCHAR(20),
    Status           VARCHAR(20),
    FOREIGN KEY (Clinic_name) REFERENCES T_Clinic (Clinic_name)
);

CREATE TABLE T_Doctor
(
    Medic_ID    INTEGER NOT NULL PRIMARY KEY,
    Attestation varchar(20)
);

CREATE TABLE T_Nurse
(
    Medic_ID INTEGER NOT NULL PRIMARY KEY
);

CREATE TABLE T_Patient
(
    Personal_ID        VARCHAR(10) NOT NULL PRIMARY KEY,
    Patient_first_name VARCHAR(20),
    Patient_last_name  VARCHAR(20),
    CHECK ( (regexp_like(Personal_ID, '^[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]$')
        AND (MOD(CAST(Personal_ID AS INTEGER), 11) = 0))
        OR (regexp_like(Personal_ID, '^[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]$')
            AND NOT regexp_like(Personal_ID, '000$')) )
);

CREATE TABLE T_Examination
(
    Exam_ID     INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Medic_ID    INTEGER,
    Personal_ID VARCHAR(10),
    Exam_Date   VARCHAR(10),
    Exam_Time   VARCHAR(5),
    Location_ID INTEGER,
    FOREIGN KEY (Medic_ID) REFERENCES T_Medic (Medic_ID),
    FOREIGN KEY (Personal_ID) REFERENCES T_Patient (Personal_ID)
);

--They are two different entities but with the same data
CREATE TABLE T_Surgery
(
    Surgery_ID   INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Personal_ID  VARCHAR(10),
    Surgery_date VARCHAR(10),
    Surgery_Time VARCHAR(5),
    Location_ID  INTEGER,
    FOREIGN KEY (Personal_ID) REFERENCES T_Patient (Personal_ID)
);

CREATE TABLE T_Surgery_participants -- Added, when we want to add multiple medics into operation
(
    Surgery_ID INTEGER,
    Medic_ID   INTEGER,
    FOREIGN KEY (Surgery_ID) REFERENCES T_Surgery (Surgery_ID),
    FOREIGN KEY (Medic_ID) REFERENCES T_Medic (Medic_ID)
);

-- Identifies location, makes code cleaner
CREATE TABLE T_Location
(
    Location_ID INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Clinic_name VARCHAR(30),
    Pavilion    VARCHAR(30),
    Room        VARCHAR(30),
    FOREIGN KEY (Clinic_name) REFERENCES T_Clinic (Clinic_name) ON DELETE CASCADE
);

CREATE TABLE T_Prescribed_Drug
(
    Drug_ID           INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Medic_ID          INTEGER,
    Personal_ID       VARCHAR(10),
    Prescription_date VARCHAR(10),
    Prescription_time VARCHAR(5),
    Cure              VARCHAR(20),
    FOREIGN KEY (Medic_ID) REFERENCES T_Medic (Medic_ID),
    FOREIGN KEY (Personal_ID) REFERENCES T_Patient (Personal_ID)
);

CREATE TABLE T_Hospitalization
(
    Hospitalization_ID INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Medic_ID           INTEGER,
    Personal_ID        VARCHAR(10),
    Date_from          varchar(10),
    Date_till          varchar(10),
    FOREIGN KEY (Medic_ID) REFERENCES T_Medic (Medic_ID),
    FOREIGN KEY (Personal_ID) REFERENCES T_Patient (Personal_ID)
);

CREATE TABLE T_Medical_equipment
(
    Medical_equipment_ID INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    Clinic_name          VARCHAR(30),
    Equipment            VARCHAR(30),
    Amount               INTEGER,
    FOREIGN KEY (Clinic_name) REFERENCES T_Clinic (Clinic_name) ON DELETE CASCADE
);

INSERT INTO T_Clinic
VALUES ('Dětské', '222333444');
INSERT INTO T_Clinic
VALUES ('Ambulance', '528625362');
INSERT INTO T_Clinic
VALUES ('Neurologie', '777777777');

INSERT INTO T_Medic
VALUES ('1', 'Alena', 'Chytrá', 'Ambulance', 'plný', 'všeobecný');
INSERT INTO T_Medic
VALUES ('2', 'Anton', 'Stašek', 'Ambulance', 'plný', 'všeobecný');
INSERT INTO T_Medic
VALUES ('3', 'Michal', 'Novotný', 'Neurologie', 'plný', 'primář');
INSERT INTO T_Medic
VALUES ('4', 'Anna', 'Černá', 'Neurologie', 'plný', 'všeobecný');
INSERT INTO T_Medic
VALUES ('5', 'Peter', 'Kasčák', 'Neurologie', 'plný', 'všeobecný');
INSERT INTO T_Medic
VALUES ('6', 'Dana', 'Loučková', 'Dětské', 'plný', 'všeobecný');
INSERT INTO T_Medic
VALUES ('7', 'David', 'Novák', 'Dětské', 'směny', 'pratik');
INSERT INTO T_Medic
VALUES ('8', 'David', 'Wentl', 'Neurologie', 'směny', 'všeobecný');
INSERT INTO T_Medic
VALUES ('9', 'Alena', 'Wentl', 'Neurologie', 'plný', 'všeobecný');

INSERT INTO T_Doctor
VALUES ('1', 'ambulantní');
INSERT INTO T_Doctor
VALUES ('2', 'ambulantní');
INSERT INTO T_Doctor
VALUES ('3', 'Dětská neurologie');
INSERT INTO T_Doctor
VALUES ('6', '');
INSERT INTO T_Doctor
VALUES ('7', '');

INSERT INTO T_Nurse
VALUES ('4');
INSERT INTO T_Nurse
VALUES ('5');
INSERT INTO T_Nurse
VALUES ('8');
INSERT INTO T_Nurse
VALUES ('9');

INSERT INTO T_Patient
VALUES ('9502146005', 'Evžen', 'Bezděk');
INSERT INTO T_Patient
VALUES ('9301049593', 'Dominik', 'Nevřela');
INSERT INTO T_Patient
VALUES ('7062012562', 'Eliška', 'Hoffmannová');
INSERT INTO T_Patient
VALUES ('100328001', 'Petr', 'Novák');
--Wrong values
--INSERT INTO T_Patient
--VALUES ('7062012555','Amálie','Hoffmannová');
--INSERT INTO T_Patient
--VALUES ('706201256','Eliška','Hoffmannová');
--INSERT INTO T_Patient
--VALUES ('706201000','Eliška','Hoffmannová');

INSERT INTO T_Medical_equipment
VALUES ('42', 'Dětské', 'Váha', '10');
INSERT INTO T_Medical_equipment
VALUES ('43', 'Ambulance', 'Postel', '76');
INSERT INTO T_Medical_equipment
VALUES ('44', 'Neurologie', 'Rentgen', '2');
INSERT INTO T_Medical_equipment
VALUES ('45', 'Dětské', 'Zraková_tabule', '10');
INSERT INTO T_Medical_equipment
VALUES ('46', 'Ambulance', 'Povlečení', '336');
INSERT INTO T_Medical_equipment
VALUES ('47', 'Neurologie', 'Magnetická_rezonance', '1');
INSERT INTO T_Medical_equipment
VALUES ('48', 'Neurologie', 'Postel', '20');

INSERT INTO T_Location
VALUES ('2413', 'Dětské', 'A', 'E21');
INSERT INTO T_Location
VALUES ('521', 'Ambulance', 'C', '127');
INSERT INTO T_Location
VALUES ('15', 'Neurologie', 'A', '11');
INSERT INTO T_Location
VALUES ('221', 'Neurologie', 'B', 'A12');

INSERT INTO T_Prescribed_Drug
VALUES ('222', '1', '9502146005', '2022-06-22', '15:01', 'diazepam');
INSERT INTO T_Prescribed_Drug
VALUES ('521', '1', '7062012562', '2022-07-09', '12:41', 'inzulin');
INSERT INTO T_Prescribed_Drug
VALUES ('634', '2', '7062012562', '2022-08-13', '21:35', 'diazepam');
INSERT INTO T_Prescribed_Drug
VALUES ('991', '2', '7062012562', '2022-05-21', '11:22', 'diazepam');
INSERT INTO T_Prescribed_Drug
VALUES ('943', '1', '100328001', '2022-08-02', '14:33', 'penicilin');
INSERT INTO T_Prescribed_Drug
VALUES ('944', '6', '100328001', '2022-09-04', '18:06', 'penicilin');
INSERT INTO T_Prescribed_Drug
VALUES ('945', '7', '100328001', '2022-10-06', '10:15', 'tyrotricin');

INSERT INTO T_Examination
VALUES ('', '6', '9502146005', '2022-08-25', '12:24', '2431');
INSERT INTO T_Examination
VALUES ('', '2', '9301049593', '2022-06-04', '07:15', '521');
INSERT INTO T_Examination
VALUES ('', '6', '9502146005', '2022-08-25', '12:24', '2431');
INSERT INTO T_Examination
VALUES ('100', '2', '9301049593', '2022-06-04', '07:15', '521');

INSERT INTO T_Surgery
VALUES ('1', '9502146005', '2022-03-01', '15:01', '2431');
INSERT INTO T_Surgery_participants
VALUES ('1', '6');
INSERT INTO T_Surgery
VALUES ('2', '9301049593', '2022-12-23', '8:00', '521');
INSERT INTO T_Surgery_participants
VALUES ('2', '3');
INSERT INTO T_Surgery_participants
VALUES ('2', '2');
INSERT INTO T_Surgery
VALUES ('3', '100328001', '2023-01-12', '9:30', '15');
INSERT INTO T_Surgery_participants
VALUES ('3', '3');
INSERT INTO T_Surgery_participants
VALUES ('3', '8');
INSERT INTO T_Surgery_participants
VALUES ('3', '9');

INSERT INTO T_Hospitalization
VALUES ('99921', '6', '9502146005', '2022-03-01', '2022-03-09');
INSERT INTO T_Hospitalization
VALUES ('99922', '2', '9301049593', '2022-12-23', '2023-01-01');

--- CREATE TRIGGERS

-- Check date trigger
CREATE OR REPLACE TRIGGER check_date
    BEFORE UPDATE OR INSERT ON T_Hospitalization
    FOR EACH ROW
DECLARE current_date  VARCHAR(10);
BEGIN
current_date :=  TO_CHAR(SYSDATE, 'YYYY-MM-DD');
    if :NEW.Date_from < current_date THEN
        :NEW.Date_from := current_date;
else
        :NEW.Date_from := :NEW.Date_from;
end if;
END;
/

INSERT INTO T_Hospitalization
VALUES ('', '2', '9301049593', '2021-12-23', '2023-01-01');
INSERT INTO T_Hospitalization
VALUES ('', '2', '9301049593', '2024-12-23', '2023-01-01');

--- END TRIGGERS

--- CREATE PROCEDURES
CREATE OR REPLACE PROCEDURE ITEM_USED
    (item_name IN VARCHAR)
AS
    CURSOR Items IS SELECT Equipment, Amount FROM T_Medical_equipment;
name T_Medical_equipment.Equipment%type;
    amount_of_items T_Medical_equipment.Amount%type;
count T_Medical_equipment.Amount%type := 0;


BEGIN
OPEN Items;
LOOP
FETCH Items INTO name,amount_of_items;
        EXIT WHEN Items%NOTFOUND;
        IF name = item_name THEN
            count := count + amount_of_items;
END IF;
END LOOP;
CLOSE Items;
DBMS_OUTPUT.put_line('Počet položek ' || item_name || ' je ' || count);

END;
/
/*BEGIN ITEM_USED('Postel'); END;*/
--- END PROCEDURES
COMMIT;
